<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../assets/main.css" rel="stylesheet" />
</head>

<body data-bs-theme="dark">
    <div id="alpineGuestbook" x-data="guestbook">
        <div class="container-xl vh-100" id="screen0" x-show="screen == 0" x-transition>
            <div class="row h-100 justify-content-center text-center align-items-center">
                <div class="col">
                    <div class="dropdown">
                        <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img id="hero-logo" src="../assets/rs-text-white.svg" />
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" @click="configStylus()">
                                    Allow only stylus: <span x-text="allowOnlyStylus"></span>
                                </a>
                            </li>
                            <li><a class="dropdown-item" href="#" @click="setwriteApiUrl()">API URL</a></li>
                            <li><a class="dropdown-item" href="#" @click="setApiKey()">API Key</a></li>
                            <li><a class="dropdown-item" href="#" @click="setEventName()">Event name</a></li>
                        </ul>
                    </div>
                    <h1>Please sign our guestbook</h1>
                    <button type="button" class="btn btn-primary btn-lg" @click="screen = 1">Sign</button>
                </div>
            </div>
        </div>
        <div class="container-xl vh-100" id="screen1" x-show="screen == 1" x-transition>
            <div class="row pt-5">
                <div class="col justify-content-center text-center align-items-center">
                    <canvas id="drawPad" class="paper" width="800px" height="600px"></canvas>
                </div>
            </div>
            <div class="row justify-content-center text-center align-items-center">
                <div class="col">
                    <button type="button" class="btn btn-primary" @click="undo()">Undo</button>
                    <button type="button" class="btn btn-primary" @click="clear()">Clear</button>
                    <button type="button" class="btn btn-primary" @click="submit()">Submit</button>
                </div>
            </div>
        </div>
        <div class="container-xl vh-100" id="screen2" x-transition>
            <div class="row h-100 justify-content-center text-center align-items-center">
                <div class="col">
                    <img id="hero-logo" src="../assets/rs-text-white.svg" />
                    <h3>Thank you!</h3>
                    <p>We have received your best wishes. It will be a part shown in the event as well.</p>
                    <button type="button" class="btn btn-primary" @click="screen = 1">Write a new one</button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script>
            function toSvgWithoutScaling(signaturePad) {
                const pointGroups = signaturePad._data;
                const minX = 0;
                const minY = 0;
                const maxX = signaturePad.canvas.width;
                const maxY = signaturePad.canvas.height;
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');

                svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                svg.setAttribute('viewBox', `${minX} ${minY} ${maxX} ${maxY}`);
                svg.setAttribute('width', maxX.toString());
                svg.setAttribute('height', maxY.toString());

                signaturePad._fromData(
                    pointGroups,

                    (curve, { penColor }) => {
                        const path = document.createElement('path');

                        // Need to check curve for NaN values, these pop up when drawing
                        // lines on the canvas that are not continuous. E.g. Sharp corners
                        // or stopping mid-stroke and than continuing without lifting mouse.
                        /* eslint-disable no-restricted-globals */
                        if (
                            !isNaN(curve.control1.x) &&
                            !isNaN(curve.control1.y) &&
                            !isNaN(curve.control2.x) &&
                            !isNaN(curve.control2.y)
                        ) {
                            const attr =
                                `M ${curve.startPoint.x.toFixed(3)},${curve.startPoint.y.toFixed(
                                    3,
                                )} ` +
                                `C ${curve.control1.x.toFixed(3)},${curve.control1.y.toFixed(3)} ` +
                                `${curve.control2.x.toFixed(3)},${curve.control2.y.toFixed(3)} ` +
                                `${curve.endPoint.x.toFixed(3)},${curve.endPoint.y.toFixed(3)}`;
                            path.setAttribute('d', attr);
                            path.setAttribute('stroke-width', (curve.endWidth * 2.25).toFixed(3));
                            path.setAttribute('stroke', penColor);
                            path.setAttribute('fill', 'none');
                            path.setAttribute('stroke-linecap', 'round');

                            svg.appendChild(path);
                        }
                        /* eslint-enable no-restricted-globals */
                    },

                    (point, { penColor, dotSize, minWidth, maxWidth }) => {
                        const circle = document.createElement('circle');
                        const size = dotSize > 0 ? dotSize : (minWidth + maxWidth) / 2;
                        circle.setAttribute('r', size.toString());
                        circle.setAttribute('cx', point.x.toString());
                        circle.setAttribute('cy', point.y.toString());
                        circle.setAttribute('fill', penColor);

                        svg.appendChild(circle);
                    },
                );
                return svg.outerHTML;
            }

            let globAllowOnlyStylus = true;
            const canvas = document.querySelector("#drawPad");
            const signaturePad = new SignaturePad(canvas, {
                minWidth: 2,
                maxWidth: 2,
                throttle: 0,
            });

            signaturePad.addEventListener("beginStroke", (evt) => {
                const pressure = evt.detail.pressure ?? evt.detail.force;
                const inputType = evt.detail.pointerType ?? evt.detail.touchType;
                if (globAllowOnlyStylus && inputType != "stylus") {
                    evt.preventDefault();
                }
            });

            document.addEventListener('alpine:init', () => {
                Alpine.data('guestbook', () => ({
                    allowOnlyStylus: globAllowOnlyStylus,
                    screen: 0,
                    async configStylus() {
                        this.allowOnlyStylus = !this.allowOnlyStylus;
                        globAllowOnlyStylus = this.allowOnlyStylus;
                    },
                    async undo() {
                        var data = signaturePad.toData();
                        if (data) {
                            data.pop(); // remove the last dot or line
                            signaturePad.fromData(data);
                        }
                    },
                    async clear() {
                        signaturePad.clear();
                    },
                    async submit() {
                        const data = toSvgWithoutScaling(signaturePad);
                        const response = await fetch(localStorage.writeApiUrl,
                            {
                                method: "PUT",
                                mode: "cors",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": localStorage.apiKey,
                                },
                                body: JSON.stringify({
                                    "event": localStorage.eventName,
                                    "content": data
                                })
                            }
                        );
                        console.log(response);
                        res = response;
                    },
                    async setwriteApiUrl() {
                        let res = prompt("Please enter API URL", (localStorage.writeApiUrl ?? ""));
                        if (res) {
                            localStorage.setItem("writeApiUrl", res);
                        }
                    },
                    async setApiKey() {
                        let redacted_api_key;
                        if (localStorage.apiKey) {
                            redacted_api_key = localStorage.apiKey.substr(0, 10) + "XXXXXXXXXXXXXXXX";
                        }
                        let res = prompt("Please enter API KEY", (redacted_api_key ?? ""));
                        if (res) {
                            localStorage.setItem("apiKey", res);
                        }
                    },
                    async setEventName() {
                        let res = prompt("Please enter event name", (localStorage.eventName ?? ""));
                        if (res) {
                            localStorage.setItem("eventName", res);
                        }
                    }
                }))
            })
        </script>
</body>

</html>