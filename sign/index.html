<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        html {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .vh-100 {
            min-height: 100vh;
        }

        #drawPad {
            border-color: black;
            border-width: 1px;
            border-style: solid;
        }
    </style>
</head>

<body>
    <div id="alpineGuestbook" x-data="guestbook">
        <div class="container-xl vh-100" id="screen1" style="display: none">
            <div class="row h-100 justify-content-center text-center align-items-center">
                <div class="col">
                    <img src="assets/rs-text.svg" width="60%" />
                </div>
            </div>
        </div>
        <div class="container-xl vh-100" id="screen2">
            <div class="row justify-content-center text-center align-items-center">
                <div class="col">
                    <canvas id="drawPad" width="800px" height="600px"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button type="button" class="btn btn-primary" x-on:click="undo()">Undo</button>
                    <button type="button" class="btn btn-primary" x-on:click="clear()">Clear</button>
                    <button type="button" class="btn btn-primary" x-on:click="submit()">Submit</button>
                </div>
                <div class="col">
                    <div class="dropdown">
                        <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown">
                            Config
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" @click="configStylus()">
                                    Allow only stylus: <span x-text="allowOnlyStylus"></span>
                                </a>
                            </li>
                            <li><a class="dropdown-item" href="#" @click="setwriteApiUrl()">API URL</a></li>
                            <li><a class="dropdown-item" href="#" @click="setApiKey()">API Key</a></li>
                            <li><a class="dropdown-item" href="#" @click="setEventName()">Event name</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        let globAllowOnlyStylus = true;
        let res;
        const canvas = document.querySelector("#drawPad");
        const signaturePad = new SignaturePad(canvas, {
            minWidth: 2,
            maxWidth: 2,
            throttle: 0,
        });

        signaturePad.addEventListener("beginStroke", (evt) => {
            const pressure = evt.detail.pressure ?? evt.detail.force;
            const inputType = evt.detail.pointerType ?? evt.detail.touchType;
            if (globAllowOnlyStylus && inputType != "stylus") {
                evt.preventDefault();
            }
        });

        document.addEventListener('alpine:init', () => {
            Alpine.data('guestbook', () => ({
                allowOnlyStylus: globAllowOnlyStylus,
                async configStylus() {
                    this.allowOnlyStylus = !this.allowOnlyStylus;
                    globAllowOnlyStylus = this.allowOnlyStylus;
                },
                async submit() {
                    const data = signaturePad.toDataURL("image/svg+xml");
                    const response = await fetch(localStorage.writeApiUrl,
                        {
                            method: "PUT",
                            mode: "cors",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": localStorage.apiKey,
                            },
                            body: JSON.stringify({
                                "event": localStorage.eventName,
                                "content": data
                            })
                        }
                    );
                    console.log(response);
                    res = response;
                },
                async undo() {
                    var data = signaturePad.toData();
                    if (data) {
                        data.pop(); // remove the last dot or line
                        signaturePad.fromData(data);
                    }
                },
                async clear() {
                    signaturePad.clear();
                },
                async setwriteApiUrl() {
                    let res = prompt("Please enter API URL", (localStorage.writeApiUrl ?? ""));
                    if (res) {
                        localStorage.setItem("writeApiUrl", res);
                    }
                },
                async setApiKey() {
                    let redacted_api_key;
                    if (localStorage.apiKey) {
                        redacted_api_key = localStorage.apiKey.substr(0, 10) + "XXXXXXXXXXXXXXXX";
                    }
                    let res = prompt("Please enter API KEY", (redacted_api_key ?? ""));
                    if (res) {
                        localStorage.setItem("apiKey", res);
                    }
                },
                async setEventName() {
                    let res = prompt("Please enter event name", (localStorage.eventName ?? ""));
                    if (res) {
                        localStorage.setItem("eventName", res);
                    }
                },
            }))
        })
    </script>
</body>

</html>